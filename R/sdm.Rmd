---
title: "sdm"
output: html_document
date: "2023-06-29"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/home/jessiejzhou/network-storage/WNV/sjv-wnv")
library(ranger)
library(rsample)
library(spatialsample)
library(dplyr)
library(pROC)
library(sdm)
set.seed(123)
```

## Loading Data, at 3000 level
```{r}
bird <- readRDS("Data/5_joinGEELag/bird3000Lag0.rds")
pool <- readRDS("Data/5_joinGEELag/pool3000Lag0.rds")
sentinel <- readRDS("Data/5_joinGEELag/sentinel3000Lag0.rds")
```

## Train/Test Split
```{r}
bird_split <- initial_split(bird, prop = 0.8, strata = clust)
bird_train <- training(bird_split)
bird_test <- testing(bird_split)
```


## CV and grid 

```{r}
# Getting lat/long
bird_sf <- read_sf("Data/2_clusterExport/bird3000/bird3000.shp") %>% 
  st_transform(4326) %>%
  mutate(centroids = st_centroid(geometry),
         long = st_coordinates(centroids)[,1],
         lat = st_coordinates(centroids)[,2]) %>%
  select(-centroids)

clusters <- spatial_block_cv(bird_sf, method = "random", n = 30, relevant_only = T, v = 5)

splits_df <- data.frame()
for (i in 1:5) {
  new_df <- assessment(clusters$splits[[i]])
  new_df$fold <- i
  splits_df <- rbind(splits_df, new_df)  # Bind all points and fold IDs together
}

splits_df <- st_drop_geometry(splits_df)
splits_df <- distinct(splits_df, clust, .keep_all = TRUE)

bird_train <- merge(bird_train, splits_df, by ="clust")
```

```{r}
bird2 <- bird_train[c("fold", "Count", "Humidity.Max", "Humidity.Min", "Specific.Humidity", "Temp.Max.K", "Temp.Min.K", "VPD.kPa", "Precip.Mean.mm...day", "EVI", "NDVI", "jrcStandingWater")]
bird2 <- bird2[sample(1:nrow(bird2)), ]
bird2 <- na.omit(bird2)

# df for results of each fold, 5-fold cv
rf_performance  <-  data.frame(model  =  rep("RF", 5),
                               fold_id  =  1:5,
                               auc  =  rep(NA, 5),
                               Count  =  rep(NA, 5),    
                               background  =  rep(NA, 5))

hypergrid_final  <-  data.frame(mtry  =  rep(NA,5),
                                node_size    =  rep(NA, 5),
                                sample_size  =  rep(NA, 5))

```


## Creating and Tuning Model
```{r}
for (i in 1:5) {
  
  train <- bird2[bird2$fold != i,]; train <- train[-1]
  test <- bird2[bird2$fold == i,]; test <- test[-1]
  
  hyper_grid <- expand.grid(mtry = seq(1,10,1),
                            node_size = seq(1,4,1),
                            sample_size = c(0.6,0.7,0.8))
  
  for (j in 1:nrow(hyper_grid)){
    
    model <- ranger(formula = Count ~ .,
                    data = train,
                    num.trees = 2000,
                    mtry = hyper_grid$mtry[j],
                    min.node.size = hyper_grid$node_size[j],
                    sample.fraction = hyper_grid$sample_size[j],`
                    probability = T,
                    replace = T,
                    splitrule = "extratrees",
                    seed = 123)
    
    hyper_grid$OOB_RMSE[j] <- sqrt(model$prediction.error)
  }
  
  hyper_grid2 <- hyper_grid %>%
    dplyr::arrange(OOB_RMSE)
  
  train_model  <-  ranger(
        formula  =  Count  ~  .,    
        data  =  train, 
        num.trees  =  2000,  
        mtry  =  hyper_grid2$mtry[1], 
        min.node.size  =  hyper_grid2$node_size[1], 
        sample.fraction  =  hyper_grid2$sample_size[1],
        probability  =  TRUE, 
        replace = TRUE,
        splitrule = "extratrees",
        seed  =  123)
  
  pred0 <- predict(train_model, data = test); pred <- pred0$predictions[,1]
  auc <- pROC::roc(response = test[,"Count"], predictor = pred, levels = c(0,1), auc = T)
  rf_performance[i, "auc"] <- auc$auc
  rf_performance[i, "Count"] <- nrow(subset(test, Count == 1))
  rf_performance[i, "background"] <- nrow(subset(test, Count == 0))
  
  hypergrid_final[i, "mtry"] <- hyper_grid2$mtry[1]
  hypergrid_final[i, "node_size"] <- hyper_grid2$node_size[1]
  hypergrid_final[i, "sample_size"] <- hyper_grid2$sample_size[1]
  
}

saveRDS(rf_performance, "/home/jessiejzhou/sjv-wnv/R/rf_performance.rds")
saveRDS(hypergrid_final, "/home/jessiejzhou/sjv-wnv/R/hypergrid_final.rds")
```


## trying the sdm package













